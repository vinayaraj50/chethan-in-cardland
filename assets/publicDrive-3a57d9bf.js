import{F as g,G as l,H as P,I as f,J as p,K as d,O as b,Q as h,V as y,W as m,Y as v,$ as S,a0 as w}from"./index-d043e65b.js";class F{async listPublicStacks(){try{console.log("[Firestore] Fetching authoritative lesson catalog...");const e=g(l,"lessons"),t=P(e,f("isActive","==",!0)),a=await p(t);return console.log("[Firestore] Query completed. Documents found:",a.size),a.empty?(console.log("[Firestore] No active lessons found."),[]):a.docs.map(o=>{const s=o.data(),r=s.type==="premium"||s.isPremium,i=s.storagePath||`lessons/${r?"premium":"free"}/${o.id}.enc`;return{id:o.id,...s,standard:s.standard||null,syllabus:s.syllabus||null,medium:s.medium||null,subject:s.subject||null,source:"firestore",isPremium:r,isPublic:!0,storagePath:i}})}catch(e){return console.error("[Firestore] Catalog fetch failed:",e),[]}}async getPublicFileContent(e){try{let t=e;t.includes("/")||(t=`lessons/${t}.enc`);const a=d(b,t),o=await h(a),s=await fetch(o);if(!s.ok)throw new Error(`Firebase Storage HTTP ${s.status}`);const r=await s.text();try{return JSON.parse(r)}catch{return r}}catch(t){return console.error("[Storage] Content Fetch Failed:",t),null}}async getPublicIndex(){return this.listPublicStacks()}async savePublicLesson(e){try{const t=e.id||Date.now().toString(),a=e.cost>0,o=`lessons/${a?"premium":"free"}/${t}.enc`;console.log(`[LessonService] Publishing to Firebase: ${o}`);const s=d(b,o),r=new Blob([JSON.stringify(e)],{type:"application/json"});await y(s,r);const i=m(l,"lessons",t),u={id:t,title:e.title,titleImage:e.titleImage||null,label:e.label||"No label",standard:e.standard||null,syllabus:e.syllabus||null,medium:e.medium||null,subject:e.subject||null,cost:e.cost||0,type:a?"premium":"free",isActive:!0,storagePath:o,updatedAt:v()};return await S(i,u,{merge:!0}),{...e,...u,source:"firestore"}}catch(t){throw console.error("[LessonService] Save failed:",t),t}}async deletePublicLesson(e){try{console.log(`[LessonService] Deactivating lesson: ${e}`);const t=m(l,"lessons",e);return await w(t,{isActive:!1}),!0}catch(t){throw console.error("[LessonService] Delete failed:",t),t}}}const c=new F,$=()=>c.listPublicStacks(),D=n=>c.getPublicFileContent(n),x=()=>c.getPublicIndex(),I=n=>c.savePublicLesson(n),R=n=>c.deletePublicLesson(n);export{c as apiService,R as deletePublicLesson,D as getPublicFileContent,x as getPublicIndex,$ as listPublicStacks,I as savePublicLesson};
