import{c as f,d as m,q as h,w as p,g as w,o as L,r as P,a as v,f as y,u as F,b as S,s as D,e as R,h as T}from"./index-aacb2cd0.js";class ${async listPublicLessons(){try{console.log("[Firestore] Fetching authoritative lesson catalog...");const e=f(m,"lessons"),s=h(e,p("isActive","==",!0)),o=await w(s);return console.log("[Firestore] Query completed. Documents found:",o.size),o.empty?(console.log("[Firestore] No active lessons found."),[]):o.docs.map(t=>this._mapDocToLesson(t))}catch(e){return console.error("[Firestore] Catalog fetch failed:",e),[]}}subscribeToPublicLessons(e){console.log("[Firestore] Subscribing to authoritative lesson catalog...");const s=f(m,"lessons"),o=h(s,p("isActive","==",!0));return L(o,t=>{console.log("[Firestore] Real-time update received. Documents:",t.size);const d=t.docs.map(i=>this._mapDocToLesson(i));e(d)},t=>{console.error("[Firestore] Subscription error:",t)})}_mapDocToLesson(e){const s=e.data(),o=s.type==="premium"||s.isPremium,t=s.storagePath||`lessons/${o?"premium":"free"}/${e.id}.enc`;return{id:e.id,...s,standard:s.standard||null,syllabus:s.syllabus||null,medium:s.medium||null,subject:s.subject||null,source:"firestore",isPremium:o,isPublic:!0,storagePath:t,questionCount:s.questionCount||s.cardsCount||0}}async getPublicFileContent(e){var i,g;let s=e;s.includes("/")||(s=`lessons/${s}.enc`),console.log("[Storage] Fetching content from:",s);const o=P(y,s),t=3,d=2e3;for(let a=1;a<=t;a++)try{const n=await Promise.race([v(o),new Promise((l,b)=>setTimeout(()=>b(new Error("Storage fetch timeout")),3e4))]),r=new TextDecoder().decode(n);console.log("[Storage] Raw content length:",r==null?void 0:r.length);try{const l=JSON.parse(r);return console.log("[Storage] Successfully parsed JSON. Questions found:",((i=l.questions)==null?void 0:i.length)||((g=l.cards)==null?void 0:g.length)||0),l}catch{return console.log("[Storage] Content is string (likely encrypted)"),r}}catch(n){const r=n.code==="storage/retry-limit-exceeded"||n.message.includes("network")||n.message.includes("timeout");if(console.warn(`[Storage] Attempt ${a}/${t} failed:`,n.message),r&&a<t){const l=d*Math.pow(2,a-1);console.log(`[Storage] Retrying in ${l}ms...`),await new Promise(b=>setTimeout(b,l));continue}throw console.error("[Storage] Content Fetch Failed after retries:",n),new Error(`Failed to download lesson content: ${n.message}`)}}async getPublicIndex(){return this.listPublicLessons()}async savePublicLesson(e){var s,o;try{const t=e.id||Date.now().toString(),d=e.cost>0,i=`lessons/${d?"premium":"free"}/${t}.enc`;console.log(`[LessonService] Publishing to Firebase: ${i}`);const g=P(y,i),a=new Blob([JSON.stringify(e)],{type:"application/json"});await F(g,a);const n=S(m,"lessons",t),r={id:t,title:e.title,titleImage:e.titleImage||null,label:e.label||"No label",standard:e.standard||null,syllabus:e.syllabus||null,medium:e.medium||null,subject:e.subject||null,cost:e.cost||0,questionCount:((s=e.questions)==null?void 0:s.length)||((o=e.cards)==null?void 0:o.length)||0,type:d?"premium":"free",isActive:!0,storagePath:i,updatedAt:D()};return await R(n,r,{merge:!0}),{...e,...r,source:"firestore"}}catch(t){throw console.error("[LessonService] Save failed:",t),t}}async deletePublicLesson(e){try{console.log(`[LessonService] Deactivating lesson: ${e}`);const s=S(m,"lessons",e);return await T(s,{isActive:!1}),!0}catch(s){throw console.error("[LessonService] Delete failed:",s),s}}}const u=new $,q=()=>u.listPublicLessons(),A=c=>u.subscribeToPublicLessons(c),_=()=>u.listPublicLessons(),B=c=>u.getPublicFileContent(c),E=()=>u.getPublicIndex(),I=c=>u.savePublicLesson(c),j=c=>u.deletePublicLesson(c);export{u as apiService,j as deletePublicLesson,B as getPublicFileContent,E as getPublicIndex,q as listPublicLessons,_ as listPublicStacks,I as savePublicLesson,A as subscribeToPublicLessons};
