import{c as f,d,q as P,w as p,g as y,r as b,f as m,a as w,u as S,b as h,s as v,e as L,h as F}from"./index-90fe5d3f.js";class C{async listPublicLessons(){try{console.log("[Firestore] Fetching authoritative lesson catalog...");const e=f(d,"lessons"),o=P(e,p("isActive","==",!0)),n=await y(o);return console.log("[Firestore] Query completed. Documents found:",n.size),n.empty?(console.log("[Firestore] No active lessons found."),[]):n.docs.map(t=>{const s=t.data(),a=s.type==="premium"||s.isPremium,r=s.storagePath||`lessons/${a?"premium":"free"}/${t.id}.enc`;return{id:t.id,...s,standard:s.standard||null,syllabus:s.syllabus||null,medium:s.medium||null,subject:s.subject||null,source:"firestore",isPremium:a,isPublic:!0,storagePath:r,questionCount:s.questionCount||s.cardsCount||0}})}catch(e){return console.error("[Firestore] Catalog fetch failed:",e),[]}}async getPublicFileContent(e){var o,n;try{let t=e;t.includes("/")||(t=`lessons/${t}.enc`),console.log("[Storage] Fetching content from:",t);const s=b(m,t),a=await w(s),r=await fetch(a);if(!r.ok)throw new Error(`Firebase Storage HTTP ${r.status}`);const c=await r.text();console.log("[Storage] Raw content length:",c==null?void 0:c.length);try{const i=JSON.parse(c);return console.log("[Storage] Successfully parsed JSON. Questions found:",((o=i.questions)==null?void 0:o.length)||((n=i.cards)==null?void 0:n.length)||0),i}catch{return console.log("[Storage] Content is string (likely encrypted)"),c}}catch(t){throw console.error("[Storage] Content Fetch Failed:",t),new Error(`Failed to download lesson content: ${t.message}`)}}async getPublicIndex(){return this.listPublicLessons()}async savePublicLesson(e){var o,n;try{const t=e.id||Date.now().toString(),s=e.cost>0,a=`lessons/${s?"premium":"free"}/${t}.enc`;console.log(`[LessonService] Publishing to Firebase: ${a}`);const r=b(m,a),c=new Blob([JSON.stringify(e)],{type:"application/json"});await S(r,c);const i=h(d,"lessons",t),g={id:t,title:e.title,titleImage:e.titleImage||null,label:e.label||"No label",standard:e.standard||null,syllabus:e.syllabus||null,medium:e.medium||null,subject:e.subject||null,cost:e.cost||0,questionCount:((o=e.questions)==null?void 0:o.length)||((n=e.cards)==null?void 0:n.length)||0,type:s?"premium":"free",isActive:!0,storagePath:a,updatedAt:v()};return await L(i,g,{merge:!0}),{...e,...g,source:"firestore"}}catch(t){throw console.error("[LessonService] Save failed:",t),t}}async deletePublicLesson(e){try{console.log(`[LessonService] Deactivating lesson: ${e}`);const o=h(d,"lessons",e);return await F(o,{isActive:!1}),!0}catch(o){throw console.error("[LessonService] Delete failed:",o),o}}}const u=new C,q=()=>u.listPublicLessons(),D=()=>u.listPublicLessons(),R=l=>u.getPublicFileContent(l),j=()=>u.getPublicIndex(),I=l=>u.savePublicLesson(l),N=l=>u.deletePublicLesson(l);export{u as apiService,N as deletePublicLesson,R as getPublicFileContent,j as getPublicIndex,q as listPublicLessons,D as listPublicStacks,I as savePublicLesson};
