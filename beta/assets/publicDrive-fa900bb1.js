import{c as b,d,q as m,w as h,g as y,o as L,r as p,f as P,a as S,u as w,b as f,s as v,e as F,h as D}from"./index-c5a9965e.js";class C{async listPublicLessons(){try{console.log("[Firestore] Fetching authoritative lesson catalog...");const e=b(d,"lessons"),s=m(e,h("isActive","==",!0)),o=await y(s);return console.log("[Firestore] Query completed. Documents found:",o.size),o.empty?(console.log("[Firestore] No active lessons found."),[]):o.docs.map(t=>this._mapDocToLesson(t))}catch(e){return console.error("[Firestore] Catalog fetch failed:",e),[]}}subscribeToPublicLessons(e){console.log("[Firestore] Subscribing to authoritative lesson catalog...");const s=b(d,"lessons"),o=m(s,h("isActive","==",!0));return L(o,t=>{console.log("[Firestore] Real-time update received. Documents:",t.size);const a=t.docs.map(r=>this._mapDocToLesson(r));e(a)},t=>{console.error("[Firestore] Subscription error:",t)})}_mapDocToLesson(e){const s=e.data(),o=s.type==="premium"||s.isPremium,t=s.storagePath||`lessons/${o?"premium":"free"}/${e.id}.enc`;return{id:e.id,...s,standard:s.standard||null,syllabus:s.syllabus||null,medium:s.medium||null,subject:s.subject||null,source:"firestore",isPremium:o,isPublic:!0,storagePath:t,questionCount:s.questionCount||s.cardsCount||0}}async getPublicFileContent(e){var s,o;try{let t=e;t.includes("/")||(t=`lessons/${t}.enc`),console.log("[Storage] Fetching content from:",t);const a=p(P,t),r=await S(a),u=await fetch(r);if(!u.ok)throw new Error(`Firebase Storage HTTP ${u.status}`);const c=await u.text();console.log("[Storage] Raw content length:",c==null?void 0:c.length);try{const l=JSON.parse(c);return console.log("[Storage] Successfully parsed JSON. Questions found:",((s=l.questions)==null?void 0:s.length)||((o=l.cards)==null?void 0:o.length)||0),l}catch{return console.log("[Storage] Content is string (likely encrypted)"),c}}catch(t){throw console.error("[Storage] Content Fetch Failed:",t),new Error(`Failed to download lesson content: ${t.message}`)}}async getPublicIndex(){return this.listPublicLessons()}async savePublicLesson(e){var s,o;try{const t=e.id||Date.now().toString(),a=e.cost>0,r=`lessons/${a?"premium":"free"}/${t}.enc`;console.log(`[LessonService] Publishing to Firebase: ${r}`);const u=p(P,r),c=new Blob([JSON.stringify(e)],{type:"application/json"});await w(u,c);const l=f(d,"lessons",t),g={id:t,title:e.title,titleImage:e.titleImage||null,label:e.label||"No label",standard:e.standard||null,syllabus:e.syllabus||null,medium:e.medium||null,subject:e.subject||null,cost:e.cost||0,questionCount:((s=e.questions)==null?void 0:s.length)||((o=e.cards)==null?void 0:o.length)||0,type:a?"premium":"free",isActive:!0,storagePath:r,updatedAt:v()};return await F(l,g,{merge:!0}),{...e,...g,source:"firestore"}}catch(t){throw console.error("[LessonService] Save failed:",t),t}}async deletePublicLesson(e){try{console.log(`[LessonService] Deactivating lesson: ${e}`);const s=f(d,"lessons",e);return await D(s,{isActive:!1}),!0}catch(s){throw console.error("[LessonService] Delete failed:",s),s}}}const i=new C,R=()=>i.listPublicLessons(),T=n=>i.subscribeToPublicLessons(n),$=()=>i.listPublicLessons(),j=n=>i.getPublicFileContent(n),A=()=>i.getPublicIndex(),I=n=>i.savePublicLesson(n),N=n=>i.deletePublicLesson(n);export{i as apiService,N as deletePublicLesson,j as getPublicFileContent,A as getPublicIndex,R as listPublicLessons,$ as listPublicStacks,I as savePublicLesson,T as subscribeToPublicLessons};
