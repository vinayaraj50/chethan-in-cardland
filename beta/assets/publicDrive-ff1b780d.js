import{c as g,d as u,q as b,w as m,g as y,o as S,r as h,f,a as L,u as v,b as p,s as w,e as F,h as D}from"./index-1d742523.js";class C{async listPublicLessons(){try{console.log("[Firestore] Fetching authoritative lesson catalog...");const e=g(u,"lessons"),s=b(e,m("isActive","==",!0)),o=await y(s);return console.log("[Firestore] Query completed. Documents found:",o.size),o.empty?(console.log("[Firestore] No active lessons found."),[]):o.docs.map(t=>this._mapDocToLesson(t))}catch(e){return console.error("[Firestore] Catalog fetch failed:",e),[]}}subscribeToPublicLessons(e){console.log("[Firestore] Subscribing to authoritative lesson catalog...");const s=g(u,"lessons"),o=b(s,m("isActive","==",!0));return S(o,t=>{console.log("[Firestore] Real-time update received. Documents:",t.size);const a=t.docs.map(c=>this._mapDocToLesson(c));e(a)},t=>{console.error("[Firestore] Subscription error:",t)})}_mapDocToLesson(e){const s=e.data(),o=s.type==="premium"||s.isPremium,t=s.storagePath||`lessons/${o?"premium":"free"}/${e.id}.enc`;return{id:e.id,...s,standard:s.standard||null,syllabus:s.syllabus||null,medium:s.medium||null,subject:s.subject||null,source:"firestore",isPremium:o,isPublic:!0,storagePath:t,questionCount:s.questionCount||s.cardsCount||0}}async getPublicFileContent(e){var s,o;try{let t=e;t.includes("/")||(t=`lessons/${t}.enc`),console.log("[Storage] Fetching content from:",t);const a=h(f,t),c=await L(a),r=new TextDecoder().decode(c);console.log("[Storage] Raw content length:",r==null?void 0:r.length);try{const l=JSON.parse(r);return console.log("[Storage] Successfully parsed JSON. Questions found:",((s=l.questions)==null?void 0:s.length)||((o=l.cards)==null?void 0:o.length)||0),l}catch{return console.log("[Storage] Content is string (likely encrypted)"),r}}catch(t){throw console.warn("[Storage] Standard SDK fetch failed:",t.message),console.error("[Storage] Content Fetch Failed:",t),new Error(`Failed to download lesson content: ${t.message}`)}}async getPublicIndex(){return this.listPublicLessons()}async savePublicLesson(e){var s,o;try{const t=e.id||Date.now().toString(),a=e.cost>0,c=`lessons/${a?"premium":"free"}/${t}.enc`;console.log(`[LessonService] Publishing to Firebase: ${c}`);const r=h(f,c),l=new Blob([JSON.stringify(e)],{type:"application/json"});await v(r,l);const P=p(u,"lessons",t),d={id:t,title:e.title,titleImage:e.titleImage||null,label:e.label||"No label",standard:e.standard||null,syllabus:e.syllabus||null,medium:e.medium||null,subject:e.subject||null,cost:e.cost||0,questionCount:((s=e.questions)==null?void 0:s.length)||((o=e.cards)==null?void 0:o.length)||0,type:a?"premium":"free",isActive:!0,storagePath:c,updatedAt:w()};return await F(P,d,{merge:!0}),{...e,...d,source:"firestore"}}catch(t){throw console.error("[LessonService] Save failed:",t),t}}async deletePublicLesson(e){try{console.log(`[LessonService] Deactivating lesson: ${e}`);const s=p(u,"lessons",e);return await D(s,{isActive:!1}),!0}catch(s){throw console.error("[LessonService] Delete failed:",s),s}}}const i=new C,R=()=>i.listPublicLessons(),T=n=>i.subscribeToPublicLessons(n),$=()=>i.listPublicLessons(),j=n=>i.getPublicFileContent(n),A=()=>i.getPublicIndex(),B=n=>i.savePublicLesson(n),I=n=>i.deletePublicLesson(n);export{i as apiService,I as deletePublicLesson,j as getPublicFileContent,A as getPublicIndex,R as listPublicLessons,$ as listPublicStacks,B as savePublicLesson,T as subscribeToPublicLessons};
